<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live Auction Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        h1 { text-align: center; margin-bottom: 10px; }

        .dashboard {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
        }

        .leaderboard-panel {
            flex: 1 1 400px;
            margin: 10px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: right;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        tr:nth-child(even){background-color: #f2f2f2;}

        .chart-panel {
            flex: 2 1 600px;
            margin: 10px;
        }
        canvas { width: 100%; height: 400px; }
    </style>
</head>
<body>
    <h1>Live Auction Dashboard</h1>
    <div class="dashboard">
        <div class="chart-panel">
            <h2>Prior Results</h2>
            <p>Round: <span id="round-chart">0</span> | Time Unit: <span id="time_unit">0</span></p>
            <canvas id="priorResultsChart"></canvas>
        </div>

        <div class="leaderboard-panel">
            <h2>Wealth Leaderboard</h2>
            <p>Round: <span id="round-leader">0</span></p>
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Email</th>
                        <th>Wealth</th>
                    </tr>
                </thead>
                <tbody id="leaderboard">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const wsLeaderboard = new WebSocket("ws://34.41.250.232:8766");

        wsLeaderboard.onmessage = function(event) {
            const data = JSON.parse(event.data);

            if (data.type === "wealth_update") {
                document.getElementById('round-leader').textContent = data.round_number;

                const sorted = Object.entries(data.wealth).sort((a,b) => b[1]-a[1]);
                const tbody = document.getElementById('leaderboard');
                tbody.innerHTML = "";

                sorted.forEach((entry, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${index+1}</td><td>${entry[0]}</td><td>${entry[1]}</td>`;
                    tbody.appendChild(tr);
                });
            }
        };

        wsLeaderboard.onopen = function() { console.log("Connected to wealth leaderboard WebSocket!"); };
        wsLeaderboard.onclose = function() { console.log("Wealth leaderboard WebSocket closed."); };

        const wsChart = new WebSocket("ws://34.41.250.232:8766");

        const ctx = document.getElementById('priorResultsChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Array.from({length: 500}, (_, i) => i),
                datasets: [{
                    label: 'Number of submissions',
                    data: Array(500).fill(0),
                    backgroundColor: 'rgba(54, 162, 235, 0.7)'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: { title: { display: true, text: 'Level' } },
                    y: { title: { display: true, text: 'Submissions' }, beginAtZero: true }
                }
            }
        });

        wsChart.onmessage = function(event) {
            const data = JSON.parse(event.data);

            if (data.type === "prior_results") {
                document.getElementById('round-chart').textContent = data.round_number;
                document.getElementById('time_unit').textContent = data.time_unit;

                chart.data.datasets[0].data = data.prior_results;
                chart.update();
            }
        };

        wsChart.onopen = function() { console.log("Connected to display WebSocket server!"); };
        wsChart.onclose = function() { console.log("Display WebSocket connection closed."); };
    </script>
</body>
</html>
